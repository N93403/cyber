#!/usr/bin/env python3
"""
BEHAVIORAL MALWARE ANALYZER
Monitors and analyzes runtime behavior of suspicious executables
"""

import os
import sys
import time
import json
import threading
from pathlib import Path
import subprocess
import psutil
import tempfile

class BehavioralAnalyzer:
    def __init__(self, sample_path, timeout=60):
        self.sample_path = Path(sample_path)
        self.timeout = timeout
        self.analysis_result = {
            'process_activity': [],
            'file_activity': [],
            'network_activity': [],
            'registry_activity': [],  # Windows specific
            'system_changes': []
        }
        self.monitoring = False
        
    def setup_environment(self):
        """Setup isolated environment for analysis"""
        # Create temporary directory for analysis
        self.temp_dir = tempfile.mkdtemp(prefix="malware_analysis_")
        print(f"üîí Analysis environment: {self.temp_dir}")
        
        # Copy sample to temp directory
        temp_sample = Path(self.temp_dir) / self.sample_path.name
        try:
            import shutil
            shutil.copy2(self.sample_path, temp_sample)
            self.temp_sample_path = temp_sample
            return True
        except Exception as e:
            print(f"‚ùå Failed to setup environment: {e}")
            return False
    
    def monitor_processes(self):
        """Monitor process creation and termination"""
        initial_processes = set(p.pid for p in psutil.process_iter())
        
        def process_monitor():
            while self.monitoring:
                try:
                    current_processes = set(p.pid for p in psutil.process_iter())
                    new_processes = current_processes - initial_processes
                    
                    for pid in new_processes:
                        try:
                            p = psutil.Process(pid)
                            process_info = {
                                'pid': pid,
                                'name': p.name(),
                                'cmdline': p.cmdline(),
                                'create_time': p.create_time(),
                                'status': p.status()
                            }
                            self.analysis_result['process_activity'].append(process_info)
                        except (psutil.NoSuchProcess, psutil.AccessDenied):
                            continue
                    
                    time.sleep(1)
                except Exception as e:
                    print(f"‚ö†Ô∏è  Process monitor error: {e}")
                    break
        
        self.process_monitor_thread = threading.Thread(target=process_monitor)
        self.process_monitor_thread.start()
    
    def monitor_file_system(self):
        """Monitor file system activity"""
        # This is a simplified version - in practice, use more sophisticated tools
        initial_files = set()
        
        def file_monitor():
            while self.monitoring:
                try:
                    # Monitor temp directory for new files
                    for root, dirs, files in os.walk(self.temp_dir):
                        for file in files:
                            file_path = os.path.join(root, file)
                            if file_path not in initial_files:
                                initial_files.add(file_path)
                                
                                file_info = {
                                    'path': file_path,
                                    'action': 'created',
                                    'timestamp': time.time(),
                                    'size': os.path.getsize(file_path) if os.path.exists(file_path) else 0
                                }
                                self.analysis_result['file_activity'].append(file_info)
                    
                    time.sleep(2)
                except Exception as e:
                    print(f"‚ö†Ô∏è  File monitor error: {e}")
                    break
        
        self.file_monitor_thread = threading.Thread(target=file_monitor)
        self.file_monitor_thread.start()
    
    def monitor_network(self):
        """Monitor network activity"""
        def network_monitor():
            while self.monitoring:
                try:
                    # Get network connections
                    connections = psutil.net_connections()
                    for conn in connections:
                        if conn.status == 'ESTABLISHED' and conn.raddr:
                            net_info = {
                                'local_address': f"{conn.laddr.ip}:{conn.laddr.port}",
                                'remote_address': f"{conn.raddr.ip}:{conn.raddr.port}",
                                'status': conn.status,
                                'timestamp': time.time()
                            }
                            self.analysis_result['network_activity'].append(net_info)
                    
                    time.sleep(5)
                except Exception as e:
                    print(f"‚ö†Ô∏è  Network monitor error: {e}")
                    break
        
        self.network_monitor_thread = threading.Thread(target=network_monitor)
        self.network_monitor_thread.start()
    
    def execute_sample(self):
        """Execute the sample in controlled environment"""
        print(f"üöÄ Executing sample: {self.temp_sample_path.name}")
        
        try:
            # Execute the sample
            process = subprocess.Popen(
                [str(self.temp_sample_path)],
                cwd=self.temp_dir,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                shell=False
            )
            
            # Wait for process completion or timeout
            try:
                stdout, stderr = process.communicate(timeout=self.timeout)
                
                self.analysis_result['execution'] = {
                    'exit_code': process.returncode,
                    'stdout': stdout.decode('utf-8', errors='ignore') if stdout else '',
                    'stderr': stderr.decode('utf-8', errors='ignore') if stderr else '',
                    'duration': self.timeout
                }
                
            except subprocess.TimeoutExpired:
                process.terminate()
                try:
                    process.wait(timeout=5)
                except subprocess.TimeoutExpired:
                    process.kill()
                
                self.analysis_result['execution'] = {
                    'exit_code': -1,
                    'stdout': '',
                    'stderr': 'Process terminated due to timeout',
                    'duration': self.timeout
                }
            
            return True
            
        except Exception as e:
            print(f"‚ùå Execution failed: {e}")
            self.analysis_result['execution'] = {
                'exit_code': -1,
                'stdout': '',
                'stderr': str(e),
                'duration': 0
            }
            return False
    
    def analyze_behavior(self):
        """Analyze collected behavioral data"""
        print("\nüìä Analyzing behavioral data...")
        
        # Process analysis
        unique_processes = len(set(p['name'] for p in self.analysis_result['process_activity']))
        self.analysis_result['summary'] = {
            'unique_processes_created': unique_processes,
            'files_created': len(self.analysis_result['file_activity']),
            'network_connections': len(self.analysis_result['network_activity']),
            'analysis_duration': self.timeout
        }
        
        # Suspicious behavior detection
        suspicious_behaviors = []
        
        # Multiple process creation
        if unique_processes > 3:
            suspicious_behaviors.append("Created multiple child processes")
        
        # Network connections to suspicious ports
        suspicious_ports = [4444, 5555, 1337, 31337, 12345]
        for conn in self.analysis_result['network_activity']:
            remote_port = int(conn['remote_address'].split(':')[1])
            if remote_port in suspicious_ports:
                suspicious_behaviors.append(f"Connected to suspicious port {remote_port}")
                break
        
        # File creation in system locations (simulated)
        system_locations = ['/tmp', '/var/tmp', '/temp']
        for file_act in self.analysis_result['file_activity']:
            if any(loc in file_act['path'] for loc in system_locations):
                suspicious_behaviors.append("Created files in temporary locations")
                break
        
        self.analysis_result['suspicious_behaviors'] = suspicious_behaviors
        
        # Behavioral score
        score = len(suspicious_behaviors) * 20
        self.analysis_result['behavioral_score'] = min(score, 100)
        
        if score >= 60:
            risk_level = "HIGH"
        elif score >= 30:
            risk_level = "MEDIUM"
        else:
            risk_level = "LOW"
        
        self.analysis_result['behavioral_risk'] = risk_level
    
    def cleanup(self):
        """Cleanup analysis environment"""
        print("\nüßπ Cleaning up analysis environment...")
        try:
            import shutil
            shutil.rmtree(self.temp_dir, ignore_errors=True)
            print("‚úÖ Cleanup completed")
        except Exception as e:
            print(f"‚ö†Ô∏è  Cleanup warning: {e}")
    
    def print_report(self):
        """Print behavioral analysis report"""
        print("\n" + "=" * 60)
        print("       BEHAVIORAL ANALYSIS REPORT")
        print("=" * 60)
        
        # Execution summary
        execution = self.analysis_result.get('execution', {})
        print(f"\nüöÄ EXECUTION SUMMARY:")
        print(f"   Exit Code: {execution.get('exit_code', 'N/A')}")
        print(f"   Duration: {execution.get('duration', 0)} seconds")
        
        # Behavioral summary
        summary = self.analysis_result.get('summary', {})
        print(f"\nüìä BEHAVIORAL SUMMARY:")
        print(f"   Processes Created: {summary.get('unique_processes_created', 0)}")
        print(f"   Files Created: {summary.get('files_created', 0)}")
        print(f"   Network Connections: {summary.get('network_connections', 0)}")
        
        # Suspicious behaviors
        suspicious = self.analysis_result.get('suspicious_behaviors', [])
        if suspicious:
            print(f"\n‚ö†Ô∏è  SUSPICIOUS BEHAVIORS:")
            for behavior in suspicious:
                print(f"   ‚Ä¢ {behavior}")
        else:
            print(f"\n‚úÖ No highly suspicious behaviors detected")
        
        # Risk assessment
        print(f"\nüéØ BEHAVIORAL RISK ASSESSMENT:")
        print(f"   Behavioral Score: {self.analysis_result.get('behavioral_score', 0)}/100")
        print(f"   Risk Level: {self.analysis_result.get('behavioral_risk', 'UNKNOWN')}")
        
        # Detailed activities
        if self.analysis_result.get('process_activity'):
            print(f"\nüîç PROCESS ACTIVITY (first 3):")
            for proc in self.analysis_result['process_activity'][:3]:
                print(f"   - {proc['name']} (PID: {proc['pid']})")
        
        if self.analysis_result.get('network_activity'):
            print(f"\nüåê NETWORK ACTIVITY (first 3):")
            for conn in self.analysis_result['network_activity'][:3]:
                print(f"   - {conn['remote_address']} ({conn['status']})")
        
        print("\n" + "=" * 60)
        print("       ANALYSIS COMPLETED")
        print("=" * 60)
    
    def analyze(self):
        """Perform complete behavioral analysis"""
        print("üî¨ BEHAVIORAL MALWARE ANALYSIS")
        print("=" * 50)
        
        # Setup environment
        if not self.setup_environment():
            return False
        
        try:
            # Start monitoring
            self.monitoring = True
            self.monitor_processes()
            self.monitor_file_system()
            self.monitor_network()
            
            print("üìä Monitoring started...")
            time.sleep(2)  # Let monitors initialize
            
            # Execute sample
            self.execute_sample()
            
            # Stop monitoring
            self.monitoring = False
            time.sleep(2)  # Let monitors capture final data
            
            # Analyze behavior
            self.analyze_behavior()
            
            return True
            
        except Exception as e:
            print(f"‚ùå Behavioral analysis failed: {e}")
            self.monitoring = False
            return False
        finally:
            self.cleanup()

def main():
    import argparse
    
    parser = argparse.ArgumentParser(description='Behavioral Malware Analyzer')
    parser.add_argument('sample', help='Path to the sample file to analyze')
    parser.add_argument('-t', '--timeout', type=int, default=60, help='Analysis timeout in seconds')
    parser.add_argument('-o', '--output', help='Output JSON report file')
    
    args = parser.parse_args()
    
    # Safety warning
    print("‚ö†Ô∏è  BEHAVIORAL ANALYSIS WARNING")
    print("This will execute the sample in an isolated environment.")
    print("Ensure you are in a controlled, disposable environment!")
    print("")
    
    response = input("Continue with analysis? (yes/NO): ")
    if response.lower() != 'yes':
        print("Analysis cancelled.")
        return
    
    # Check sample
    if not os.path.exists(args.sample):
        print(f"‚ùå Sample file not found: {args.sample}")
        return
    
    # Perform analysis
    analyzer = BehavioralAnalyzer(args.sample, args.timeout)
    if analyzer.analyze():
        analyzer.print_report()
        
        # Save results if requested
        if args.output:
            with open(args.output, 'w') as f:
                json.dump(analyzer.analysis_result, f, indent=2)
            print(f"\nüíæ Report saved to: {args.output}")
    else:
        print("‚ùå Behavioral analysis failed")

if __name__ == "__main__":
    main()
