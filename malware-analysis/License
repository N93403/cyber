
## **2. scripts/setup_analysis_environment.sh**
```bash
#!/bin/bash
# Malware Analysis Environment Setup Script

echo "ğŸ”§ MALWARE ANALYSIS ENVIRONMENT SETUP"
echo "======================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Check if running in VM (safety check)
check_environment() {
    log_info "Checking analysis environment..."
    
    # Detect virtualization
    if systemd-detect-virt > /dev/null 2>&1; then
        log_success "Running in virtualized environment: $(systemd-detect-virt)"
    else
        log_warning "Not detected as virtualized environment - proceed with caution"
    fi
    
    # Check for analysis tools
    local tools=("python3" "wget" "curl" "git" "file" "strings")
    local missing_tools=()
    
    for tool in "${tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -ne 0 ]; then
        log_warning "Missing tools: ${missing_tools[*]}"
    fi
}

# Install basic analysis tools
install_basic_tools() {
    log_info "Installing basic analysis tools..."
    
    if command -v apt-get &> /dev/null; then
        # Debian/Ubuntu/Kali
        sudo apt-get update
        sudo apt-get install -y \
            python3 python3-pip python3-dev \
            wget curl git \
            file strings binutils \
            hexdump xxd \
            yara \
            upx-ucl \
            radare2 \
            foremost scalpel \
            tcpdump tshark
        
    elif command -v yum &> /dev/null; then
        # RHEL/CentOS
        sudo yum install -y \
            python3 python3-pip \
            wget curl git \
            file binutils \
            hexedit \
            yara \
            upx \
            radare2 \
            tcpdump wireshark
        
    else
        log_error "Unsupported package manager"
        return 1
    fi
}

# Install Python analysis libraries
install_python_tools() {
    log_info "Installing Python analysis libraries..."
    
    pip3 install --upgrade pip
    
    # Basic analysis
    pip3 install \
        pefile \
        yara-python \
        capstone \
        ropper \
        keystone-engine \
        pycrypto \
        requests \
        beautifulsoup4 \
        lxml
    
    # Advanced analysis
    pip3 install \
        volatility3 \
        malduck \
        malwasm \
        mmbot-core
    
    # Network analysis
    pip3 install \
        scapy \
        pyshark \
        dpkt
    
    log_success "Python tools installed"
}

# Setup analysis directories
setup_directories() {
    log_info "Setting up analysis directory structure..."
    
    local dirs=(
        "samples/benign"
        "samples/malicious/generated"
        "samples/malicious/real"  # Empty - for user samples
        "tools/custom"
        "reports/static"
        "reports/dynamic"
        "reports/memory"
        "environments/vm_templates"
        "databases/yara_rules"
        "logs/analysis"
    )
    
    for dir in "${dirs[@]}"; do
        mkdir -p "$dir"
        log_info "Created: $dir"
    done
    
    # Create safety marker files
    echo "MALWARE ANALYSIS DIRECTORY - USE WITH CAUTION" > samples/CAUTION_README.txt
    echo "DO NOT STORE REAL MALWARE SAMPLES IN THIS REPOSITORY" > samples/malicious/real/README.txt
}

# Download and setup YARA rules
setup_yara_rules() {
    log_info "Setting up YARA rules..."
    
    local yara_dir="databases/yara_rules"
    
    # Download common YARA rule sets
    if command -v wget &> /dev/null; then
        wget -q -O "$yara_dir/index.yar" "https://raw.githubusercontent.com/Yara-Rules/rules/master/index.yar"
        wget -q -O "$yara_dir/malware.yar" "https://raw.githubusercontent.com/Yara-Rules/rules/master/malware.yar"
    fi
    
    # Create custom rules
    cat > "$yara_dir/custom_malware_rules.yar" << 'EOF'
rule Suspicious_Base64_Strings {
    strings:
        $base64_pattern = /[A-Za-z0-9+\/]{40,}={0,2}/
    condition:
        any of them
}

rule High_Entropy_Section {
    condition:
        pe.sections[0].entropy > 7.0
}

rule Suspicious_Imports {
    strings:
        $virtual_alloc = "VirtualAlloc" wide ascii
        $create_remote_thread = "CreateRemoteThread" wide ascii
        $write_process_memory = "WriteProcessMemory" wide ascii
    condition:
        any of them
}

rule Potential_Packer {
    strings:
        $upx_header = "UPX0"
        $upx_header2 = "UPX1"
        $aspack = "ASPack"
        $fsg = "FSG!"
    condition:
        any of them
}
EOF
    
    log_success "YARA rules configured"
}

# Create analysis configuration
create_config() {
    log_info "Creating analysis configuration..."
    
    cat > config/analysis.conf << EOF
# Malware Analysis Configuration
[environment]
analysis_vm = true
network_isolation = true
logging_enabled = true

[analysis]
max_file_size = 10485760  # 10MB
allowed_file_types = exe,dll,scr,com,bat,ps1,doc,docx,xls,xlsx
timeout_seconds = 300

[safety]
auto_snapshot = true
network_capture = false  # Enable only in isolated environments
upload_samples = false

[paths]
samples_dir = ./samples
reports_dir = ./reports
tools_dir = ./tools
logs_dir = ./logs

[yara]
rules_dir = ./databases/yara_rules
enable_custom_rules = true
enable_community_rules = true
EOF
    
    log_success "Configuration file created"
}

# Setup logging and safety measures
setup_safety() {
    log_info "Configuring safety measures..."
    
    # Create analysis log
    mkdir -p logs
    echo "Analysis session started: $(date)" > logs/analysis_session.log
    
    # Create safety script
    cat > scripts/safety_check.sh << 'EOF'
#!/bin/bash
# Safety check for malware analysis

echo "ğŸ”’ SAFETY CHECK"
echo "================"

# Check if running in VM
if systemd-detect-virt > /dev/null 2>&1; then
    echo "âœ… Running in: $(systemd-detect-virt)"
else
    echo "âš ï¸  Not in detected virtual environment"
fi

# Check network connections
echo "ğŸŒ Network connections:"
netstat -tunlp 2>/dev/null | head -10

# Check current user
echo "ğŸ‘¤ Current user: $(whoami)"

# Check system resources
echo "ğŸ’» System resources:"
free -h

echo "ğŸ” Safety check completed at: $(date)"
EOF
    
    chmod +x scripts/safety_check.sh
    
    log_success "Safety measures configured"
}

# Main setup function
main() {
    echo ""
    echo "ğŸ”¬ MALWARE ANALYSIS LAB SETUP"
    echo "=============================="
    echo ""
    
    check_environment
    setup_directories
    install_basic_tools
    install_python_tools
    setup_yara_rules
    create_config
    setup_safety
    
    echo ""
    echo "âœ… SETUP COMPLETED SUCCESSFULLY!"
    echo ""
    echo "ğŸ¯ NEXT STEPS:"
    echo "1. Review configuration: cat config/analysis.conf"
    echo "2. Run safety check: ./scripts/safety_check.sh"
    echo "3. Generate test samples: ./scripts/generate_malware_samples.sh"
    echo "4. Start analysis: python3 scripts/basic_static_analyzer.py --help"
    echo ""
    echo "âš ï¸  REMEMBER: Always analyze malware in isolated environments!"
}

# Run setup
main
